<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>HomeFeed</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-180.png">
    <link rel="stylesheet" href="/static/style.css">
    <!-- Preload JS modules to parallelize fetch and eliminate waterfall -->
    <link rel="modulepreload" href="/static/js/state.js">
    <link rel="modulepreload" href="/static/js/api.js">
    <link rel="modulepreload" href="/static/js/viewport.js">
    <link rel="modulepreload" href="/static/js/utils/path.js">
    <link rel="modulepreload" href="/static/js/utils/video.js">
    <link rel="modulepreload" href="/static/js/utils/gif.js">
    <link rel="modulepreload" href="/static/js/comments.js">
    <style>
        /* Additional styles for optimized loading */
        .image-slide {
            background: #000;
        }
        .image-slide img {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .image-slide img.loaded {
            opacity: 1;
        }
        .image-slide video.loaded {
            opacity: 1;
        }

        /* Profile info row: main content wrapper that gets greyed out when profiles disabled */
        #profileInfoRow {
            flex-wrap: nowrap;
            gap: 8px;
        }
        .profile-info-main {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 8px;
            min-width: 0;
        }
        .profile-info-main .settings-toggle-info {
            flex: 1;
            min-width: 0;
        }
        /* Greyed-out state when Enable Profiles is off */
        .profile-info-main.profiles-disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        /* Log Out button in profiles tab - uses same style as Switch Profile but subdued */
        .settings-logout-profile-btn {
            flex-shrink: 0;
        }
        /* Danger-styled button for destructive actions */
        .settings-danger-btn {
            color: #ff453a !important;
            border-color: rgba(255, 69, 58, 0.4) !important;
        }
        .settings-danger-btn:hover {
            background: rgba(255, 69, 58, 0.12) !important;
            border-color: rgba(255, 69, 58, 0.7) !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay - visible by default, hidden when first image loads -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner-main">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
        </div>
    </div>
    
    <!-- Pull-to-Refresh Tip (slides down from top as nav is dragged) -->
    <div class="pull-refresh-tip" id="pullRefreshTip" aria-hidden="true">
        <div class="pull-refresh-icon" id="pullRefreshIcon">
            <!-- Arrow SVG - rotates when threshold met -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                 stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <polyline points="19 12 12 19 5 12"></polyline>
            </svg>
        </div>
        <span class="pull-refresh-text" id="pullRefreshText">Pull to refresh</span>
    </div>
    
    <!-- Right-side Action Bar (TikTok style) -->
    <div class="action-bar" id="actionBar">
        <!-- Heart/Favorite Button -->
        <button class="action-btn heart-action" id="heartBtn" title="Add to favorites">
            <svg class="heart-outline" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <svg class="heart-filled" viewBox="0 0 24 24" fill="#FF2D55" style="display: none;">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
        </button>
        
        <!-- Trash/Mark for Deletion Button -->
        <button class="action-btn trash-action" id="trashBtn" title="Mark for deletion">
            <svg class="trash-outline" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            <svg class="trash-filled" viewBox="0 0 24 24" fill="#FF3B30" stroke="#FF3B30" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <rect x="9" y="10" width="2" height="7" fill="#FF3B30"></rect>
                <rect x="13" y="10" width="2" height="7" fill="#FF3B30"></rect>
            </svg>
        </button>
        
        <!-- Comments Button -->
        <button class="action-btn comments-action" id="commentsBtn" title="Comments">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span class="comments-badge" id="commentsBadge" style="display: none;">0</span>
        </button>
        
        <!-- Shuffle Toggle Button -->
        <button class="action-btn" id="shuffleBtn" title="Toggle shuffle">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="16 3 21 3 21 8"></polyline>
                <line x1="4" y1="20" x2="21" y2="3"></line>
                <polyline points="21 16 21 21 16 21"></polyline>
                <line x1="15" y1="15" x2="21" y2="21"></line>
                <line x1="4" y1="4" x2="9" y2="9"></line>
            </svg>
        </button>
        
        <!-- Info Button -->
        <button class="action-btn info-btn" id="infoBtn" title="Image info">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        </button>
        
        <!-- Settings Button -->
        <button class="action-btn" id="settingsBtn" title="Settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </button>
    </div>
    
    <!-- TikTok-style Top Navigation -->
    <div class="top-nav" id="topNav">
        <!-- Filter/Sort Button -->
        <button class="top-nav-filter" id="topNavFilter" title="Sort options">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="5" r="2"></circle>
                <circle cx="12" cy="12" r="2"></circle>
                <circle cx="12" cy="19" r="2"></circle>
            </svg>
            <div class="top-nav-dropdown" id="topNavDropdown">
                <div class="dropdown-option active" data-sort="newest">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="17 11 12 6 7 11"></polyline>
                        <line x1="12" y1="18" x2="12" y2="6"></line>
                    </svg>
                    <span>New ‚Üí Old</span>
                </div>
                <div class="dropdown-option" data-sort="oldest">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="7 13 12 18 17 13"></polyline>
                        <line x1="12" y1="6" x2="12" y2="18"></line>
                    </svg>
                    <span>Old ‚Üí New</span>
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-option" data-sort="jump">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    <span>Go to Photo #</span>
                </div>
            </div>
        </button>
        
        <!-- Folder Tabs (horizontally scrollable) -->
        <div class="top-nav-tabs" id="topNavTabs">
            <!-- Tabs populated by JavaScript -->
        </div>
        
        <!-- Search Button -->
        <button class="top-nav-search" id="topNavSearch" title="Browse folders">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
    </div>
    
    <!-- Auto-Advance Active Indicator -->
    <div class="auto-advance-indicator" id="autoAdvanceIndicator" style="display: none;" title="Auto-advance active - click to disable">
        <svg viewBox="0 0 24 24" fill="white">
            <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/>
        </svg>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast-notification" id="toastNotification" style="display: none;"></div>
    
    <!-- Jump to photo modal -->
    <div class="jump-modal" id="jumpModal" style="display: none;">
        <div class="jump-modal-content">
            <h3>Jump to Photo</h3>
            <div class="jump-input-group">
                <input type="number" id="jumpInput" min="1" placeholder="Enter photo #">
                <span class="jump-total">/ <span id="jumpTotal">0</span></span>
            </div>
            <div class="jump-buttons">
                <button class="jump-btn cancel" id="jumpCancel">Cancel</button>
                <button class="jump-btn go" id="jumpGo">Go</button>
            </div>
        </div>
    </div>
    
    <!-- Scroll container -->
    <div class="scroll-container" id="scrollContainer">
        <!-- Slides rendered here by JavaScript -->
    </div>
    
    <!-- No images state -->
    <div class="no-images" id="noImages" style="display: none;">
        <h2>No Images Found</h2>
        <p>Add some folders to get started</p>
        <button class="no-images-settings-btn" id="noImagesSettingsBtn">Go to Settings</button>
    </div>
    
    <!-- No favorites state -->
    <div class="no-images" id="noFavorites" style="display: none;">
        <h2 id="noFavoritesTitle">No Favorites Yet</h2>
        <p id="noFavoritesMessage">Double-tap photos to add them to your favorites</p>
        <button class="exit-filter-btn" id="exitFilterBtn">View All Photos</button>
    </div>
    
    <!-- No trash state -->
    <div class="no-images" id="noTrash" style="display: none;">
        <h2>Trash is Empty</h2>
        <p>Swipe left on photos to mark them for deletion</p>
        <button class="exit-filter-btn" id="exitTrashBtn">View All Photos</button>
    </div>
    
    <!-- No unseen state (all photos have been seen, or after reset) -->
    <div class="no-images" id="noUnseen" style="display: none;">
        <div class="no-unseen-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M9 9l6 6M15 9l-6 6" stroke="#34C759"></path>
            </svg>
        </div>
        <h2>You're All Caught Up!</h2>
        <p>You've seen every photo in your library.<br>Reset your history to start fresh.</p>
        <button class="exit-filter-btn" id="exitUnseenBtn">View All Photos</button>
    </div>
    
    <!-- Trash animation overlay -->
    <div class="trash-animation" id="trashAnimation">
        <svg viewBox="0 0 24 24" fill="none" stroke="#FF3B30" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
    </div>
    
    <!-- Info Modal -->
    <div class="info-modal" id="infoModal" style="display: none;">
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h3>Info</h3>
                <button class="info-modal-close" id="infoModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <!-- View History section -->
            <div class="settings-seen-section info-modal-seen-section">
                <div class="settings-seen-header">View History</div>
                <div class="settings-seen-stats">
                    <div class="settings-seen-stat">
                        <div class="settings-seen-stat-value" id="seenStatCount">0</div>
                        <div class="settings-seen-stat-label">Seen</div>
                    </div>
                    <div class="settings-seen-stat">
                        <div class="settings-seen-stat-value" id="seenStatUnseen">0</div>
                        <div class="settings-seen-stat-label">New</div>
                    </div>
                    <div class="settings-seen-stat">
                        <div class="settings-seen-stat-value" id="seenStatScrolls">0</div>
                        <div class="settings-seen-stat-label">Total Scrolls</div>
                    </div>
                    <div class="settings-seen-stat">
                        <div class="settings-seen-stat-value" id="seenStatProgress">0%</div>
                        <div class="settings-seen-stat-label">Progress</div>
                    </div>
                </div>
                <button class="settings-reset-seen-btn" id="resetSeenBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                    <span>Reset Watch History</span>
                </button>
            </div>
            <!-- Image Info section (dynamic) -->
            <div class="info-modal-body" id="infoModalBody">
                <!-- Metadata populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Folders Modal -->
    <div class="info-modal" id="foldersModal" style="display: none;">
        <div class="folders-modal-content">
            <div class="info-modal-header">
                <h3>Folders</h3>
                <button class="info-modal-close" id="foldersModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="folders-modal-body" id="foldersModalBody">
                <!-- Search and sort controls -->
                <div class="folders-controls">
                    <div class="folders-search-container">
                        <svg class="folders-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" class="folders-search-input" id="foldersSearchInput" placeholder="Search folders...">
                    </div>
                    <div class="folders-sort-container">
                        <select class="folders-sort-select" id="foldersSortSelect">
                            <option value="count">Most Images</option>
                            <option value="name">A-Z</option>
                            <option value="newest">Newest</option>
                        </select>
                    </div>
                </div>
                <!-- Folder list populated by JavaScript -->
                <div class="folders-list" id="foldersList">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="info-modal" id="settingsModal" style="display: none;">
        <div class="settings-modal-content">
            <div class="info-modal-header">
                <h3>Settings</h3>
                <div class="settings-header-actions">
                </div>
                <button class="info-modal-close" id="settingsModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Tab Bar -->
            <div class="settings-tab-bar">
                <button class="settings-tab active" data-tab="folders">Folders</button>
                <button class="settings-tab" data-tab="display">Display</button>
                <button class="settings-tab" data-tab="performance">Performance</button>
                <button class="settings-tab" data-tab="profiles" id="settingsProfilesTab" style="display:none">Profiles</button>
            </div>
            
            <div class="settings-modal-body" id="settingsModalBody">
                <!-- Folders Tab Content -->
                <div class="settings-tab-content active" id="settingsTabFolders">
                    <!-- Add folder form -->
                    <div class="settings-folder-section">
                        <h4>Add Folder</h4>
                        <form class="settings-add-folder-form" id="settingsAddFolderForm">
                            <input
                                type="text"
                                id="settingsFolderPath"
                                placeholder="Enter folder path (e.g., ~/Pictures/July)"
                                autocapitalize="off"
                                autocorrect="off"
                            >
                            <button type="submit">Add</button>
                        </form>
                    </div>
                    
                    <!-- Message area -->
                    <div id="settingsMessage" class="settings-message" style="display: none;"></div>
                    
                    <!-- Stats -->
                    <div class="settings-stats">
                        <div class="settings-stat-card">
                            <div class="settings-stat-number" id="settingsFolderCount">0</div>
                            <div class="settings-stat-label">Folders</div>
                        </div>
                        <div class="settings-stat-card">
                            <div class="settings-stat-number" id="settingsImageCount">0</div>
                            <div class="settings-stat-label">Images</div>
                        </div>
                    </div>
                    
                    <!-- Folder list -->
                    <div class="settings-folder-section">
                        <h4>Folders</h4>
                        <div id="settingsFolderList">
                            <div class="settings-empty-state">
                                <p>No folders added yet</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trash section -->
                    <div class="settings-trash-section">
                        <button class="settings-trash-btn" id="settingsTrashBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            <span>Review Trash</span>
                            <span class="trash-badge" id="settingsTrashBadge" style="display: none;">0</span>
                        </button>
                    </div>
                    
                </div>
                
                <!-- Display Tab Content -->
                <div class="settings-tab-content" id="settingsTabDisplay">
                    <!-- Fill Screen Toggle -->
                    <div class="settings-toggle-item">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Fill Screen</div>
                            <div class="settings-toggle-desc">Crop images to fill screen - optimized for iPhone</div>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="toggleFillScreen">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                    
                    <!-- Auto-Advance Toggle -->
                    <div class="settings-toggle-item">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Auto-Advance</div>
                            <div class="settings-toggle-desc">Auto-scroll when video ends or after delay for photos</div>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="toggleAutoAdvance">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                    
                    <!-- Auto-Advance Delay -->
                    <div class="settings-toggle-item" id="autoAdvanceDelayItem">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Photo Delay</div>
                            <div class="settings-toggle-desc">Seconds before auto-advancing: <span id="autoAdvanceDelayValue">3</span>s</div>
                        </div>
                        <input type="range" id="autoAdvanceDelaySlider" min="1" max="10" value="3" class="settings-slider">
                    </div>

                    <!-- Date Fallback Priority -->
                    <div class="settings-toggle-item">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Date Fallback Priority</div>
                            <div class="settings-toggle-desc">When a photo has no EXIF date, sort by: <strong id="dateSourceLabel">Modified Date</strong></div>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="toggleDateSource">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-sub-desc" id="dateSourceSubDesc">
                        Off = Modified Date first &nbsp;|&nbsp; On = Created Date first
                    </div>

                </div>

                <!-- Performance Tab Content -->
                <div class="settings-tab-content" id="settingsTabPerformance">
                    <p class="settings-tab-description">
                        Performance optimizations create cached versions for faster loading.
                        <span class="ffmpeg-required">Requires FFMPEG</span>
                    </p>
                    
                    <!-- Thumbnail Cache Toggle -->
                    <div class="settings-toggle-item">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Image Thumbnails</div>
                            <div class="settings-toggle-desc">Resize images to screen size, convert to WebP</div>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="toggleThumbnailCache">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                    
                    <!-- Video Poster Toggle -->
                    <div class="settings-toggle-item">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Video Posters</div>
                            <div class="settings-toggle-desc">Show instant preview while video loads</div>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="toggleVideoPoster">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                    
                    <!-- Preload Distance -->
                    <div class="settings-toggle-item">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Preload Distance</div>
                            <div class="settings-toggle-desc">Slides to preload ahead: <span id="preloadDistanceValue">3</span></div>
                        </div>
                        <input type="range" id="preloadDistanceSlider" min="0" max="10" value="3" class="settings-slider">
                    </div>
                    
                    <!-- HDD Friendly Mode -->
                    <div class="settings-toggle-item">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">HDD Friendly</div>
                            <div class="settings-toggle-desc">Reduces scan frequency to minimize disk I/O, ideal for NAS or mechanical hard drives</div>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="toggleHDDFriendly">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Clear Cache Button -->
                    <div class="settings-cache-row">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Cache Size</div>
                            <div class="settings-toggle-desc" id="cacheSizeDisplay">Calculating...</div>
                        </div>
                        <button class="settings-clear-cache-btn" id="clearCacheBtn">
                            Clear Cache
                        </button>
                    </div>
                </div>

                <!-- Profiles Tab Content -->
                <div class="settings-tab-content" id="settingsTabProfiles">
                    <!-- Current profile info row: greyed-out section + always-on Log Out -->
                    <div class="settings-toggle-item" id="profileInfoRow" style="display:none">
                        <div class="profile-info-main" id="profileInfoMain">
                            <div class="settings-toggle-info">
                                <div class="settings-toggle-title" id="profileInfoName"></div>
                                <div class="settings-toggle-desc" id="profileInfoRole"></div>
                            </div>
                            <button class="settings-switch-profile-btn" id="settingsSwitchProfileBtn" style="display:none">Switch Profile</button>
                        </div>
                        <!-- Log Out sits outside the greyed area so it stays clickable when profiles are disabled -->
                        <button class="settings-switch-profile-btn settings-logout-profile-btn" id="settingsLogoutHeaderBtn" style="display:none">Log Out</button>
                    </div>

                    <!-- Manage Profiles (admin only) -->
                    <div class="settings-toggle-item" id="manageProfilesRow" style="display:none">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Manage Profiles</div>
                            <div class="settings-toggle-desc">Create, edit, or delete profiles and assign folders</div>
                        </div>
                        <button class="settings-switch-profile-btn" id="settingsManageProfilesBtn">Manage</button>
                    </div>

                    <!-- Enable Profiles toggle (admin only) -->
                    <div class="settings-toggle-item" id="profilesToggleRow" style="display:none">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Enable Profiles</div>
                            <div class="settings-toggle-desc">Show "Who's watching?" after login to keep separate feeds per person</div>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="toggleProfiles">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Delete All Profile Data (admin only) -->
                    <div class="settings-toggle-item" id="deleteAllProfilesRow" style="display:none">
                        <div class="settings-toggle-info">
                            <div class="settings-toggle-title">Delete All Profile Data</div>
                            <div class="settings-toggle-desc">Remove all other profiles, their favorites, watch history, and folder settings</div>
                        </div>
                        <button class="settings-switch-profile-btn settings-danger-btn" id="deleteAllProfilesBtn">Delete All</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Trash Modal -->
    <div class="info-modal" id="trashModal" style="display: none;">
        <div class="trash-modal-content">
            <div class="info-modal-header">
                <h3>üóëÔ∏è Trash</h3>
                <button class="info-modal-close" id="trashModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="trash-modal-body" id="trashModalBody">
                <div class="trash-info">
                    <p>Photos marked for deletion will appear here. You can review them before permanently deleting.</p>
                    <div class="trash-count-info">
                        <span id="trashCountInfo">0 photos marked for deletion</span>
                    </div>
                </div>
                <div class="trash-actions">
                    <button class="trash-action-btn view-trash-btn" id="viewTrashBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Review Trash
                    </button>
                    <button class="trash-action-btn empty-trash-btn" id="emptyTrashBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"></path>
                        </svg>
                        Empty Trash
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="delete-confirm-modal" id="deleteConfirmModal" style="display: none;">
        <div class="delete-confirm-content">
            <div class="delete-confirm-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="#FF3B30" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
            <h3>Delete Photos Permanently?</h3>
            <p id="deleteConfirmMessage">This will permanently delete 0 photos from your device. This action cannot be undone.</p>
            <div class="delete-confirm-buttons">
                <button class="delete-confirm-btn cancel" id="deleteCancelBtn">Cancel</button>
                <button class="delete-confirm-btn delete" id="deleteConfirmBtn">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Keyboard Shortcuts Modal -->
    <div class="info-modal" id="shortcutsModal" style="display: none;">
        <div class="shortcuts-modal-content">
            <div class="info-modal-header">
                <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                <button class="info-modal-close" id="shortcutsModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="shortcuts-modal-body">
                <div class="shortcuts-section">
                    <h4>Navigation</h4>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">J</span>
                            <span class="key-separator">or</span>
                            <span class="key">‚Üì</span>
                        </div>
                        <div class="shortcut-desc">Scroll down one image</div>
                    </div>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">K</span>
                            <span class="key-separator">or</span>
                            <span class="key">‚Üë</span>
                        </div>
                        <div class="shortcut-desc">Scroll up one image</div>
                    </div>
                </div>
                <div class="shortcuts-section">
                    <h4>Actions</h4>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">L</span>
                            <span class="key-separator">or</span>
                            <span class="key">‚Üí</span>
                        </div>
                        <div class="shortcut-desc">Like image</div>
                    </div>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">H</span>
                            <span class="key-separator">or</span>
                            <span class="key">‚Üê</span>
                        </div>
                        <div class="shortcut-desc">Mark for deletion</div>
                    </div>
                </div>
                <div class="shortcuts-section">
                    <h4>Views</h4>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">F</span>
                        </div>
                        <div class="shortcut-desc">Favorites</div>
                    </div>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">D</span>
                        </div>
                        <div class="shortcut-desc">Marked for Deletion folder</div>
                    </div>
                </div>
                <div class="shortcuts-section">
                    <h4>Video</h4>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">M</span>
                        </div>
                        <div class="shortcut-desc">Mute/Unmute video</div>
                    </div>
                </div>
                <div class="shortcuts-section">
                    <h4>Modals</h4>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">I</span>
                        </div>
                        <div class="shortcut-desc">Toggle Info modal</div>
                    </div>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">S</span>
                        </div>
                        <div class="shortcut-desc">Toggle Settings modal</div>
                    </div>
                    <div class="shortcut-row">
                        <div class="shortcut-keys">
                            <span class="key">?</span>
                        </div>
                        <div class="shortcut-desc">Show this help</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- File path display at bottom left -->
    <div class="file-path-display" id="filePathDisplay"></div>

    <!-- Comments Panel (TikTok-style bottom sheet) -->
    <div class="comments-overlay" id="commentsOverlay" style="display: none;" aria-hidden="true"></div>
    <div class="comments-panel" id="commentsPanel" aria-label="Comments">
        <!-- Drag handle -->
        <div class="comments-handle"></div>
        <div class="comments-header">
            <span class="comments-title">Comments</span>
            <span class="comments-count" id="commentsPanelCount"></span>
            <button class="comments-close-btn" id="commentsPanelClose" aria-label="Close comments">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Sidecar caption (shown when a .txt file exists alongside the photo) -->
        <div class="comments-sidecar" id="commentsSidecar" style="display: none;">
            <div class="sidecar-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sidecar-icon">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span class="sidecar-label">Caption / Notes File</span>
                <button class="sidecar-edit-btn" id="sidecarEditBtn" title="Edit caption file">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
            </div>
            <!-- Read view -->
            <div class="sidecar-text" id="sidecarText"></div>
            <!-- Edit view (hidden by default) -->
            <div class="sidecar-edit-area" id="sidecarEditArea" style="display: none;">
                <textarea class="sidecar-textarea" id="sidecarTextarea" rows="4" placeholder="Edit caption..."></textarea>
                <div class="sidecar-edit-actions">
                    <button class="sidecar-btn cancel" id="sidecarCancelBtn">Cancel</button>
                    <button class="sidecar-btn save" id="sidecarSaveBtn">Save</button>
                </div>
            </div>
        </div>

        <!-- Comments list -->
        <div class="comments-list" id="commentsList">
            <!-- Populated by JavaScript -->
        </div>

        <!-- Empty state -->
        <div class="comments-empty" id="commentsEmpty" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <p>No comments yet</p>
            <span>Be the first to add a note about this photo</span>
        </div>

        <!-- New comment input -->
        <div class="comments-input-area" id="commentsInputArea">
            <div class="comments-input-row">
                <textarea
                    class="comments-input"
                    id="commentsInput"
                    placeholder="Add a comment..."
                    rows="1"
                    maxlength="2000"
                ></textarea>
                <button class="comments-send-btn" id="commentsSendBtn" disabled>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Load the modular JavaScript application -->
    <script type="module" src="/static/js/app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>
